<!DOCTYPE html>
<html>
  <head>
    <title>Remote Particle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <script type="text/javascript" src="https://codeorigin.jquery.com/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function() {
        var statusTimer = null;
        var timer1;
        var refresh1 = 5000; // refresh rate in milliseconds (set to 0 to disable)
        var baseURL = "https://api.particle.io/v1/devices/";

        // START - EDITABLE USER DATA
        var accessToken = "dd25fbdacb51dd604cee2405392dc88db2daf889";
        var deviceID1 = "e00fce68256dd9147325bc9a";
	      var deviceID2 = "e00fce68afb66a4d1ddebe2b";

        // App Heading
        var appHeading1 = "Remote Particle";
        var appHeading2 = "";

        // Button Labels
        var label1 = "PIR 1"; // button label (set to "" to disable)
        var label2 = "PIR 2"; 
        var label3 = "BREAK 1"; 
        var label4 = "BREAK 2"; 
        var label5 = "RAD 1"; 
        var label6 = "IMU 1"; 
        var label7 = "HUMAN 1"; 
        
        // Variable 1 - PIR 1
        var varKey1 = "pir1";
        var var1onLabel = "MOTION DETECTED";
        var var1offLabel = "";
        var var1onState = 1; // Set to null to allow raw value to be displayed.
        var var1offState = 0; // Set to null to allow raw value to be displayed.

        // Variable 2 - PIR 2
        var varKey2 = "pir2";
        var var2onLabel = "MOTION DETECTED";
        var var2offLabel = "";
        var var2onState = 1; // Set to null to allow raw value to be displayed.
        var var2offState = 0; // Set to null to allow raw value to be displayed.

        // Variable 3 - BREAK 1
        var varKey3 = "break1";
        var var3onLabel = "BREAK DETECTED";
        var var3offLabel = "";
        var var3onState = 1; // Set to null to allow raw value to be displayed.
        var var3offState = 0; // Set to null to allow raw value to be displayed.

        // Variable 4 - BREAK 2
        var varKey4 = "break2";
        var var4onLabel = "BREAK DETECTED";
        var var4offLabel = "";
        var var4onState = 1; // Set to null to allow raw value to be displayed.
        var var4offState = 0; // Set to null to allow raw value to be displayed.

	      // Variable 5 - RAD 1
        var varKey5 = "rad1";
        var var5onLabel = "RAD DETECTED";
        var var5offLabel = "";

	      // Variable 6 - IMU 1
        var varKey6 = "imu1";
        var var6onLabel = "MOTION DETECTED";
        var var6offLabel = "";

	      // Variable 7 - HUMAN 1
        var varKey7 = "human1";
        var var7onLabel = "MOTION DETECTED";
        var var7offLabel = "";

        var varKey8 = "battV1"; // Variable 8 - HUB BATT 1
        var varKey9 = "battV2"; // Variable 9 - HUB BATT 2
        
        var failureDevice1 = 0; // failure on device 1
        var failureDevice2 = 0; // failure on device 2

        const textList = document.getElementById('textList'); // scroll-bar window
        //
        // END - EDITABLE USER DATA
        //--------------------------------------------------------------

        // Update app heading
        $("#app-heading").html(appHeading1 + appHeading2);

        // Override button styles
        $(".btn-lg").css({"width":"60%"});

        // Update button labels to code definitions
        // or hide them if not defined.
        (label1) ? $("#button-1").html(label1) : $("#button-1").hide();
        (label2) ? $("#button-2").html(label2) : $("#button-2").hide();
        (label3) ? $("#button-3").html(label3) : $("#button-3").hide();
        (label4) ? $("#button-4").html(label4) : $("#button-4").hide();
        (label5) ? $("#button-5").html(label5) : $("#button-5").hide();
        (label6) ? $("#button-6").html(label6) : $("#button-6").hide();
        (label7) ? $("#button-7").html(label7) : $("#button-7").hide();

        // Override text input styles
        $(".form-control").css({"display":"inline","width":"35%"});

        // Hide variable text fields if not in use (not including battery levels)
        if(refresh1 === 0) {
          $("#var-val-1").hide();
          $("#var-val-2").hide();
          $("#var-val-3").hide();
          $("#var-val-4").hide();
          $("#var-val-5").hide();
          $("#var-val-6").hide();
          $("#var-val-7").hide();
        }

        // Auto-refresh
        // Turn on/off the variable refresh if refresh rates are defined
        if(refresh1) 
        {
          $("#get-var-1").attr("disabled", "disabled");
          $("#get-var-2").attr("disabled", "disabled");
          $("#get-var-3").attr("disabled", "disabled");
          $("#get-var-4").attr("disabled", "disabled");
          $("#get-var-5").attr("disabled", "disabled");
          $("#get-var-6").attr("disabled", "disabled");
          $("#get-var-7").attr("disabled", "disabled");

          timer1 = setInterval(function () { 
            $("#var-val-1").val(var1offLabel).css("border", "3px solid green");
            $("#var-val-2").val(var2offLabel).css("border", "3px solid green");
            $("#var-val-3").val(var3offLabel).css("border", "3px solid green");
            $("#var-val-4").val(var4offLabel).css("border", "3px solid green");
            $("#var-val-5").val(var5offLabel).css("border", "3px solid green");
            $("#var-val-6").val(var6offLabel).css("border", "3px solid green");
            $("#var-val-7").val(var7offLabel).css("border", "3px solid green");
            getVariable1(); 
            getVariable2();
            getVariable3();
            getVariable4();
            getVariable5();
            getVariable6();
            getVariable7();
            getVariable8();
            getVariable9();
            getVariable10();
            getVariable11();
            getVariable12();
            getVariable13();
            getVariable14();
          }, refresh1);
        }

        // Alerts
        $("#info-alert").alert();
        $("#info-alert").affix();

        onMethodFailure(); // Show "No Connection" initially

        // Methods
        function onMethodSuccess() {
          alert = $("#info-alert");
          alert.text("Connection Established").removeClass("alert-danger").addClass("alert-success");
          alert.show();
        }

        function onMethodFailure(data) {
          alert = $("#info-alert");
          alert.text((data)?"No Response "+data:"No Connection").removeClass("alert-success").addClass("alert-danger");
          alert.show();
        }

        $("#button-1").on("click", function () { getVariable1(); });
        $("#button-2").on("click", function () { getVariable2(); });
        $("#button-3").on("click", function () { getVariable3(); });
        $("#button-4").on("click", function () { getVariable4(); });
        $("#button-5").on("click", function () { getVariable5(); });
        $("#button-6").on("click", function () { getVariable6(); });
        $("#button-7").on("click", function () { getVariable7(); });

        // Variables
        function getVariableHub(variable, callback, deviceID) {
          $.ajax({
          dataType: 'json',
          method: 'GET',
          url: 'https://api.particle.io/v1/devices/' + deviceID + '/' + variable,
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Accept': 'application/json'
          },
          success: function(obj) {
            console.log(obj);
            onMethodSuccess()
            // (obj.coreInfo.deviceID && obj.coreInfo.deviceID == deviceID) ? onMethodSuccess() : onMethodFailure((obj.error)?obj.error:"");
            callback(obj.result);
            if (deviceID == failureDevice1) failureDevice1 = 0;
            if (deviceID == failureDevice2) failureDevice2 = 0;
          },
          error: function(obj) {
            if (deviceID == failureDevice1) failureDevice1 = 1;
            if (deviceID == failureDevice2) failureDevice2 = 1;
            if (failureDevice1 && failureDevice2) onMethodFailure(); // if both devices fail, show failure message
          }
          });
        }

        // Get variable methods
        function getVariable1() { // PIR 1
          getVariableHub(varKey1, function (res) {
            if(res === var1onState) {
              $("#var-val-1").val(var1onLabel).css("border", "3px solid red");
              addMoreItems("PIR 1");
            }
            else if(res === var1offState)
              $("#var-val-1").val(var1offLabel).css("border", "3px solid green");
          }, deviceID1);
        }
        function getVariable2() { // PIR 1
          getVariableHub(varKey1, function (res) {
            if(res === var1onState) {
              $("#var-val-1").val(var1onLabel).css("border", "3px solid red");
              addMoreItems("PIR 1");
            }
            else if(res === var1offState)
              $("#var-val-1").val(var1offLabel).css("border", "3px solid green");
          }, deviceID2);
        }

        function getVariable3() { // PIR 2
          getVariableHub(varKey2, function (res) {
            if(res === var2onState) {
              $("#var-val-2").val(var2onLabel).css("border", "3px solid red");
              addMoreItems("PIR 2");
            }
            else if(res === var2offState)
              $("#var-val-2").val(var2offLabel).css("border", "3px solid green");
          }, deviceID1);
        }
        function getVariable4() { // PIR 2
          getVariableHub(varKey2, function (res) {
            if(res === var2onState) {
              $("#var-val-2").val(var2onLabel).css("border", "3px solid red");
              addMoreItems("PIR 2");
            }
            else if(res === var2offState)
              $("#var-val-2").val(var2offLabel).css("border", "3px solid green");
          }, deviceID2);
        }

        function getVariable5() { // BREAK 1
          getVariableHub(varKey3, function (res) {
            if(res === var3onState) {
              $("#var-val-3").val(var3onLabel).css("border", "3px solid red");
              addMoreItems("BREAK 1");
            }
            else if(res === var3offState)
              $("#var-val-3").val(var3offLabel).css("border", "3px solid green");
          }, deviceID1);
        }
        function getVariable6() { // BREAK 1
          getVariableHub(varKey3, function (res) {
            if(res === var3onState) {
              $("#var-val-3").val(var3onLabel).css("border", "3px solid red");
              addMoreItems("BREAK 1");
            }
            else if(res === var3offState)
              $("#var-val-3").val(var3offLabel).css("border", "3px solid green");
          }, deviceID2);
        }

        function getVariable7() { // BREAK 1
          getVariableHub(varKey4, function (res) {
            if(res === var4onState) {
              $("#var-val-4").val(var4onLabel).css("border", "3px solid red");
              addMoreItems("BREAK 2");
            }
            else if(res === var4offState)
              $("#var-val-4").val(var4offLabel).css("border", "3px solid green");
          }, deviceID1);
        }
        function getVariable8() { // BREAK 1
          getVariableHub(varKey4, function (res) {
            if(res === var4onState) {
              $("#var-val-4").val(var4onLabel).css("border", "3px solid red");
              addMoreItems("BREAK 2");
            }
            else if(res === var4offState)
              $("#var-val-4").val(var4offLabel).css("border", "3px solid green");
          }, deviceID2);
        }

	      function getVariable9() { // RAD 1
          getVariableHub(varKey5, function (res) {
            if (parseFloat(res) > 0.5) {
              $("#var-val-5").val(res).css("border", "3px solid red");
              addMoreItems("RAD 1");
            }
            else if (parseInt(res) != -1){
              $("#var-val-5").val(res).css("border", "3px solid green");
            }
          }, deviceID2);
        }
	      function getVariable10() { // IMU 1
          getVariableHub(varKey6, function (res) {
            if (parseFloat(res) > 1.0) {
              $("#var-val-6").val(res).css("border", "3px solid red");
              addMoreItems("IMU 1");
            }
            else if (parseInt(res) != -1) {
              $("#var-val-6").val(res).css("border", "3px solid green");
            }
          }, deviceID2);
        }

        function getVariable11() { // HUMAN 1
          getVariableHub(varKey7, function (res) {
            if (parseInt(res) == 0) {
              $("#var-val-7").val("NO PRESENCE").css("border", "3px solid green");
            }
            else if (parseInt(res) > 1) {
              $("#var-val-7").val(res).css("border", "3px solid red");
              addMoreItems("HUMAN 1");
            }
          }, deviceID1);
        }
	      function getVariable12() { // HUMAN 1
          getVariableHub(varKey7, function (res) {
            if (parseInt(res) == 0) {
              $("#var-val-7").val("NO PRESENCE").css("border", "3px solid green");
            }
            else if (parseInt(res) > 1) {
              $("#var-val-7").val(res).css("border", "3px solid red");
              addMoreItems("HUMAN 1");
            }
          }, deviceID2);
        }

        function getVariable13() {
          appHeading = "";
          getVariableHub(varKey8, function (res) {
            appHeading1 = `HUB 01: Battery ${res}%`;
            $("#app-heading").html(appHeading1 + appHeading2);
          }, deviceID1);
        }
	      function getVariable14() {
          appHeading = "";
          getVariableHub(varKey9, function (res) {
            appHeading2 = `  HUB 02: Battery ${res}%`;
            $("#app-heading").html(appHeading1 + appHeading2);
          }, deviceID2);
        }

        function addMoreItems(detectorName) {
          const now = new Date();
          const utcHours = now.getUTCHours();
          const utcMinutes = now.getUTCMinutes();
          const utcSeconds = now.getUTCSeconds();
          const formattedTime = `${String(utcHours).padStart(2, '0')}:${String(utcMinutes).padStart(2, '0')}:${String(utcSeconds).padStart(2, '0')}`;
          const newItem = document.createElement('li');
          newItem.textContent = `UTC Time: ${formattedTime} Alarm on ${detectorName}`;
          textList.prepend(newItem);
        }
      });
    </script>

    <div class="container">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <h4 class="panel-title" id="app-heading">
            Control
          </h4>
        </div>
        <div id="buttons" class="panel">
          <div class="panel-body">
            <button type="button" class="btn btn-primary btn-lg" id="button-1">BUTTON 1</button>
            <input type="text" class="form-control" value="---" readonly id="var-val-1"><br/><br/>
            <button type="button" class="btn btn-primary btn-lg" id="button-2">BUTTON 2</button>
            <input type="text" class="form-control" value="---" readonly id="var-val-2"><br/><br/>
            <button type="button" class="btn btn-primary btn-lg" id="button-3">BUTTON 3</button>
            <input type="text" class="form-control" value="---" readonly id="var-val-3"><br/><br/>
            <button type="button" class="btn btn-primary btn-lg" id="button-4">BUTTON 4</button>
            <input type="text" class="form-control" value="---" readonly id="var-val-4"><br/><br/>
	          <button type="button" class="btn btn-primary btn-lg" id="button-5">BUTTON 5</button>
            <input type="text" class="form-control" value="---" readonly id="var-val-5"><br/><br/>
	          <button type="button" class="btn btn-primary btn-lg" id="button-6">BUTTON 6</button>
            <input type="text" class="form-control" value="---" readonly id="var-val-6"><br/><br/>
	          <button type="button" class="btn btn-primary btn-lg" id="button-7">BUTTON 7</button>
            <input type="text" class="form-control" value="---" readonly id="var-val-7"><br/><br/>
          </div>
        </div>
        <div class="alert fade in" id="info-alert" hidden data-spy="affix"></div>
      </div>
      <div class="scroll-container">
        <ul id="textList">
        </ul>
      </div>
    </div>
  </body>
</html>
